<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creacarti | Lee, Crea y Apoya</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="bg-slate-50 font-sans antialiased text-slate-900">

<div id="app" class="min-h-screen">
    <nav class="bg-white/80 backdrop-blur-md border-b sticky top-0 z-50 px-6 py-4 flex justify-between items-center">
        <h1 @click="view = 'explore'" class="text-2xl font-black text-indigo-600 cursor-pointer tracking-tighter">CREACARTI</h1>
        <div class="flex gap-6 items-center font-bold text-sm">
            <button @click="view = 'explore'" :class="view === 'explore' ? 'text-indigo-600' : 'text-slate-400'">Explorar</button>
            
            <template v-if="user">
                <button @click="view = 'dashboard'" :class="view === 'dashboard' ? 'text-indigo-600' : 'text-slate-400'">Panel Creador</button>
                <div class="flex items-center gap-3 bg-slate-100 px-4 py-2 rounded-2xl border border-slate-200">
                    <span class="text-xs text-slate-600">{{ user.email }}</span>
                    <button @click="handleLogout" class="text-red-500 hover:scale-110 transition"><i class="fas fa-power-off"></i></button>
                </div>
            </template>
            <button v-else @click="view = 'auth'" class="bg-indigo-600 text-white px-6 py-2.5 rounded-2xl shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition">Empezar</button>
        </div>
    </nav>

    <main v-if="view === 'explore'" class="max-w-7xl mx-auto p-6">
        <header class="mb-12 py-10">
            <h2 class="text-4xl font-black mb-2">üå± Descubrimiento Justo</h2>
            <p class="text-slate-500 text-lg">Historias frescas, sin algoritmos que favorezcan solo a los grandes.</p>
        </header>

        <div v-if="loading" class="text-center py-20"><i class="fas fa-spinner fa-spin text-3xl text-indigo-200"></i></div>
        
        <div v-else class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
            <div v-for="obra in obras" :key="obra.id" class="group bg-white rounded-[2rem] overflow-hidden border border-slate-100 hover:shadow-2xl transition-all duration-500 flex flex-col">
                <div class="h-56 bg-slate-100 flex items-center justify-center relative overflow-hidden">
                    <img v-if="obra.portada_url" :src="obra.portada_url" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                    <i v-else class="fas fa-book-open text-5xl text-slate-200"></i>
                    <div class="absolute top-4 left-4 bg-white/90 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest text-indigo-600 shadow-sm border border-indigo-50">{{ obra.tipo }}</div>
                </div>
                <div class="p-6 flex-grow">
                    <h3 class="text-xl font-bold mb-2 group-hover:text-indigo-600 transition-colors">{{ obra.titulo }}</h3>
                    <p class="text-sm text-slate-400 line-clamp-2 leading-relaxed">{{ obra.descripcion }}</p>
                </div>
                <div class="p-6 pt-0">
                    <button @click="abrirObra(obra)" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold hover:bg-indigo-600 transition-all shadow-lg hover:shadow-indigo-100">Leer historia</button>
                </div>
            </div>
        </div>
    </main>

    <main v-if="view === 'reader'" class="max-w-4xl mx-auto p-6 py-12">
        <button @click="view = 'explore'" class="mb-8 text-slate-400 hover:text-indigo-600 transition flex items-center gap-2 font-bold">
            <i class="fas fa-chevron-left text-xs"></i> BIBLIOTECA
        </button>

        <div v-if="!capitulos.length" class="bg-white p-16 rounded-[3rem] text-center border shadow-xl">
            <i class="fas fa-feather-pointed text-5xl text-indigo-100 mb-6"></i>
            <h3 class="text-2xl font-bold mb-2">Pr√≥ximamente</h3>
            <p class="text-slate-400">El creador a√∫n no ha publicado cap√≠tulos para esta obra.</p>
        </div>

        <div v-else class="space-y-8">
            <div class="bg-white rounded-[3rem] shadow-2xl shadow-slate-200/50 border border-slate-100 p-10">
                <div class="border-b border-slate-50 pb-8 mb-10 flex flex-col md:flex-row justify-between md:items-end gap-6">
                    <div>
                        <h2 class="text-4xl font-black text-slate-800">{{ obraActiva.titulo }}</h2>
                        <div class="flex items-center gap-3 mt-3">
                            <span class="bg-indigo-50 text-indigo-600 text-[10px] font-black px-3 py-1 rounded-full uppercase">CAP. {{ capituloActualIndex + 1 }}</span>
                            <p class="text-slate-400 font-bold">{{ capitulos[capituloActualIndex].titulo_capitulo }}</p>
                        </div>
                    </div>
                </div>

                <div class="prose prose-indigo max-w-none text-xl leading-relaxed text-slate-700 min-h-[500px] whitespace-pre-wrap font-serif">
                    {{ capitulos[capituloActualIndex].contenido_texto }}
                    <img v-if="capitulos[capituloActualIndex].contenido_url" :src="capitulos[capituloActualIndex].contenido_url" class="mx-auto mt-12 rounded-3xl shadow-2xl border-8 border-slate-50">
                </div>

                <div class="flex justify-between items-center mt-16 pt-10 border-t border-slate-50">
                    <button @click="cambiarCapitulo(-1)" :disabled="capituloActualIndex === 0" class="px-8 py-3 rounded-2xl border-2 font-bold text-slate-600 disabled:opacity-20 hover:bg-slate-50 transition">Anterior</button>
                    <span class="text-xs font-black text-slate-300 uppercase tracking-[0.2em]">Capi {{ capituloActualIndex + 1 }} / {{ capitulos.length }}</span>
                    <button @click="cambiarCapitulo(1)" :disabled="capituloActualIndex === capitulos.length - 1" class="px-8 py-3 rounded-2xl bg-indigo-600 text-white font-bold disabled:opacity-20 hover:bg-indigo-700 transition shadow-xl shadow-indigo-100">Siguiente</button>
                </div>
            </div>

            <section class="bg-indigo-600 rounded-[3rem] p-10 text-white flex flex-col md:flex-row justify-between items-center gap-10">
                <div>
                    <h3 class="text-3xl font-black mb-2 italic">¬øTe gusta lo que lees?</h3>
                    <p class="text-indigo-100 font-medium">Tu apoyo directo permite que esta obra contin√∫e.</p>
                </div>
                <div class="flex gap-4">
                    <button v-for="monto in [1, 5, 10]" @click="registrarDonacion(monto)" class="bg-white text-indigo-600 w-16 h-16 rounded-full font-black hover:scale-125 transition-all shadow-xl">
                        ${{ monto }}
                    </button>
                </div>
            </section>

            <section class="bg-white rounded-[3rem] border border-slate-100 p-10 shadow-xl">
                <h3 class="text-2xl font-black text-slate-800 mb-10">üí¨ Comunidad</h3>
                <div v-if="user" class="mb-12">
                    <textarea v-model="nuevoComentario" placeholder="¬øQu√© te ha parecido este cap√≠tulo?" class="w-full bg-slate-50 rounded-[2rem] p-6 outline-none focus:ring-4 focus:ring-indigo-50 border-none text-slate-700 transition" rows="3"></textarea>
                    <button @click="postearComentario" class="mt-4 bg-slate-900 text-white px-8 py-3 rounded-2xl font-bold hover:bg-indigo-600 transition shadow-lg">Publicar</button>
                </div>
                <div v-else class="p-10 bg-slate-50 rounded-[2rem] text-center border-2 border-dashed border-slate-200 mb-12">
                    <p class="text-slate-400 font-bold">Para comentar, <button @click="view = 'auth'" class="text-indigo-600 hover:underline">inicia sesi√≥n aqu√≠</button>.</p>
                </div>

                <div class="space-y-10">
                    <div v-for="c in listaComentarios" :key="c.id" class="flex gap-6">
                        <div class="w-12 h-12 bg-gradient-to-tr from-indigo-500 to-indigo-700 rounded-2xl flex items-center justify-center text-white font-black shadow-lg">U</div>
                        <div>
                            <div class="flex items-center gap-3 mb-2">
                                <span class="font-black text-slate-800">Lector An√≥nimo</span>
                                <span class="text-[10px] font-black text-slate-300 uppercase tracking-widest">{{ new Date(c.fecha_comentario).toLocaleDateString() }}</span>
                            </div>
                            <p class="text-slate-500 text-lg leading-relaxed">{{ c.mensaje }}</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <main v-if="view === 'dashboard'" class="max-w-6xl mx-auto p-6 py-12">
        <div class="flex justify-between items-center mb-12">
            <h2 class="text-4xl font-black text-slate-800 tracking-tighter">Panel de Creador</h2>
            <button @click="showModalObra = true" class="bg-indigo-600 text-white px-8 py-4 rounded-[1.5rem] font-black shadow-2xl shadow-indigo-100 hover:scale-105 transition flex items-center gap-3">
                <i class="fas fa-plus"></i> CREAR OBRA
            </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
            <div class="lg:col-span-1 bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-xl">
                <h3 class="text-xl font-black mb-8 text-slate-400 uppercase tracking-widest">Tus Publicaciones</h3>
                <div v-if="obrasPropias.length === 0" class="text-center py-10"><p class="text-slate-300 text-sm">No has publicado nada a√∫n.</p></div>
                <div class="space-y-4">
                    <div v-for="o in obrasPropias" :key="o.id" 
                         @click="prepararCapitulo(o)"
                         :class="obraParaCapitulo?.id === o.id ? 'border-indigo-600 bg-indigo-50' : 'border-slate-50 hover:bg-slate-50'"
                         class="p-5 border-2 rounded-2xl cursor-pointer transition-all relative group">
                        <div class="pr-8">
                            <p class="font-black text-slate-800">{{ o.titulo }}</p>
                            <p class="text-[10px] font-black text-indigo-400 uppercase tracking-tighter">{{ o.tipo }}</p>
                        </div>
                        <button @click.stop="eliminarObra(o.id)" class="absolute top-5 right-4 text-slate-300 hover:text-red-500 transition-colors">
                            <i class="fas fa-trash-can text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div v-if="obraParaCapitulo" class="bg-white p-10 rounded-[2.5rem] border-2 border-indigo-100 shadow-2xl">
                    <h3 class="text-2xl font-black text-indigo-600 mb-8">Nuevo Cap√≠tulo: {{ obraParaCapitulo.titulo }}</h3>
                    <div class="space-y-6">
                        <div class="grid grid-cols-4 gap-4">
                            <input v-model="nuevoCap.titulo" placeholder="T√≠tulo (Ej: La traves√≠a)" class="col-span-3 p-5 bg-slate-50 rounded-2xl outline-none focus:ring-4 focus:ring-indigo-50">
                            <input v-model.number="nuevoCap.orden" type="number" placeholder="N¬∫" class="p-5 bg-slate-50 rounded-2xl outline-none text-center font-bold">
                        </div>
                        <textarea v-model="nuevoCap.contenido" placeholder="Escribe tu historia aqu√≠..." class="w-full p-6 bg-slate-50 rounded-2xl outline-none focus:ring-4 focus:ring-indigo-50 min-h-[300px]" rows="8"></textarea>
                        <div class="bg-indigo-50 p-6 rounded-2xl">
                            <p class="text-xs font-black text-indigo-400 uppercase mb-3"><i class="fas fa-image mr-2"></i> Multimedia (Solo para C√≥mic/Webtoon)</p>
                            <input v-model="nuevoCap.url" placeholder="URL de la imagen o p√°gina..." class="w-full p-4 bg-white rounded-xl outline-none text-sm">
                        </div>
                        <button @click="subirCapitulo" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black shadow-xl hover:bg-indigo-600 transition-all uppercase tracking-widest">Publicar ahora</button>
                    </div>
                </div>
                <div v-else class="h-full flex items-center justify-center bg-slate-100 rounded-[2.5rem] border-4 border-dashed border-slate-200 p-20 text-center">
                    <p class="text-slate-400 font-bold">Selecciona una obra de la izquierda para a√±adir cap√≠tulos.</p>
                </div>
            </div>
        </div>

        <div v-if="showModalObra" class="fixed inset-0 bg-slate-900/80 backdrop-blur-md z-[100] flex items-center justify-center p-6">
            <div class="bg-white rounded-[3rem] p-10 max-w-xl w-full shadow-2xl">
                <h3 class="text-3xl font-black text-slate-800 mb-8">Nueva Obra</h3>
                <div class="space-y-5">
                    <input v-model="nuevaObra.titulo" placeholder="T√≠tulo de tu obra" class="w-full p-5 bg-slate-50 rounded-2xl outline-none focus:ring-4 focus:ring-indigo-100 transition font-bold">
                    <div class="flex gap-4">
                        <button v-for="t in ['libro', 'comic', 'webtoon']" 
                                @click="nuevaObra.tipo = t"
                                :class="nuevaObra.tipo === t ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-100 text-slate-400'"
                                class="flex-1 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition">
                            {{ t }}
                        </button>
                    </div>
                    <textarea v-model="nuevaObra.descripcion" placeholder="Sinopsis de la historia..." class="w-full p-5 bg-slate-50 rounded-2xl outline-none" rows="4"></textarea>
                    <div class="flex gap-4 pt-6">
                        <button @click="showModalObra = false" class="flex-1 py-4 text-slate-300 font-black uppercase text-xs">Cancelar</button>
                        <button @click="crearObra" class="flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-xl shadow-indigo-100">DAR DE ALTA</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <main v-if="view === 'auth'" class="max-w-md mx-auto mt-24 p-12 bg-white rounded-[3.5rem] border border-slate-100 shadow-2xl text-center">
        <div class="mb-10">
            <div class="w-20 h-20 bg-indigo-600 text-white rounded-[2rem] flex items-center justify-center text-4xl mx-auto mb-6 shadow-2xl shadow-indigo-200 font-black italic">C</div>
            <h2 class="text-3xl font-black text-slate-800 tracking-tight">Bienvenido a Creacarti</h2>
            <p class="text-slate-400 font-medium mt-2">Gestiona tu biblioteca y tus obras.</p>
        </div>
        
        <div class="space-y-4">
            <input v-model="auth.email" type="email" placeholder="Email" class="w-full p-5 bg-slate-50 rounded-2xl outline-none focus:ring-4 focus:ring-indigo-100 transition font-bold">
            <input v-model="auth.password" type="password" placeholder="Contrase√±a" class="w-full p-5 bg-slate-50 rounded-2xl outline-none focus:ring-4 focus:ring-indigo-100 transition font-bold text-center tracking-[0.5em]">
            
            <div class="grid grid-cols-2 gap-4 pt-2">
                <button @click="handleLogin" class="bg-slate-900 text-white py-5 rounded-[1.5rem] font-black shadow-xl hover:bg-slate-800 transition-all uppercase tracking-widest text-xs">
                    Entrar
                </button>
                <button @click="handleRegister" class="bg-indigo-600 text-white py-5 rounded-[1.5rem] font-black shadow-xl hover:bg-indigo-700 transition-all uppercase tracking-widest text-xs">
                    Registrarme
                </button>
            </div>
        </div>
        <p class="mt-8 text-[9px] text-slate-300 uppercase font-black tracking-[0.2em] leading-loose">
            Si te registras, revisa tu email<br>para confirmar la cuenta.
        </p>
    </main>
</div>

<script>
    const { createApp } = Vue;

    const SUPABASE_URL = 'https://upjrizgkkcjugwlflnuq.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwanJpemdra2NqdWd3bGZsbnVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMjkyODIsImV4cCI6MjA4NDcwNTI4Mn0.TbeRqxWNip0_2n_mcoRO9_DABQRihvtB7Oz3TBtHtA4';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    createApp({
        data() {
            return {
                view: 'explore',
                user: null,
                loading: false,
                obras: [],
                obrasPropias: [],
                capitulos: [],
                listaComentarios: [],
                obraActiva: null,
                capituloActualIndex: 0,
                nuevoComentario: '',
                showModalObra: false,
                obraParaCapitulo: null,
                auth: { email: '', password: '' },
                nuevaObra: { titulo: '', tipo: 'libro', descripcion: '' },
                nuevoCap: { titulo: '', orden: 1, contenido: '', url: '' }
            }
        },
        async mounted() {
            const { data: { user } } = await _supabase.auth.getUser();
            this.user = user;
            
            this.fetchObras();
            if(this.user) this.fetchObrasPropias();

            _supabase.auth.onAuthStateChange((event, session) => {
                this.user = session?.user || null;
                if(this.user) this.fetchObrasPropias();
            });
        },
        methods: {
            async handleLogin() {
                if (!this.auth.email || !this.auth.password) return alert("Rellena todos los campos");
                const { data, error } = await _supabase.auth.signInWithPassword({ email: this.auth.email, password: this.auth.password });
                if (error) alert("Error al entrar: " + error.message);
                else { this.user = data.user; this.view = 'explore'; }
            },
            async handleRegister() {
                if (!this.auth.email || !this.auth.password) return alert("Rellena todos los campos");
                const { error } = await _supabase.auth.signUp({ email: this.auth.email, password: this.auth.password });
                if (error) alert("Error en el registro: " + error.message);
                else alert("¬°Cuenta creada! Revisa tu email para confirmar tu cuenta.");
            },
            async handleLogout() {
                await _supabase.auth.signOut();
                this.user = null;
                this.view = 'explore';
            },

            async fetchObras() {
                this.loading = true;
                const { data } = await _supabase.from('obras').select('*').order('fecha_creacion', { ascending: false });
                this.obras = data || [];
                this.loading = false;
            },
            async fetchObrasPropias() {
                if(!this.user) return;
                const { data } = await _supabase.from('obras').select('*').eq('autor_id', this.user.id);
                this.obrasPropias = data || [];
            },
            async crearObra() {
                const { error } = await _supabase.from('obras').insert({
                    autor_id: this.user.id,
                    titulo: this.nuevaObra.titulo,
                    tipo: this.nuevaObra.tipo,
                    descripcion: this.nuevaObra.descripcion
                });
                if (error) alert(error.message);
                else {
                    this.showModalObra = false;
                    this.fetchObras();
                    this.fetchObrasPropias();
                    this.nuevaObra = { titulo: '', tipo: 'libro', descripcion: '' };
                }
            },

            // --- NUEVO M√âTODO: ELIMINAR OBRA ---
            async eliminarObra(id) {
                if(!confirm("¬øEst√°s seguro de que deseas eliminar esta obra? Se borrar√°n tambi√©n todos sus cap√≠tulos y comentarios de forma permanente.")) return;

                const { error } = await _supabase.from('obras').delete().eq('id', id);

                if (error) {
                    alert("Error al eliminar la obra: " + error.message);
                } else {
                    // Si la obra eliminada era la seleccionada en el panel de cap√≠tulos, la limpiamos
                    if (this.obraParaCapitulo?.id === id) this.obraParaCapitulo = null;
                    
                    // Refrescamos las listas
                    this.fetchObras();
                    this.fetchObrasPropias();
                }
            },

            async abrirObra(obra) {
                this.obraActiva = obra;
                this.view = 'reader';
                this.capituloActualIndex = 0;
                await this.cargarCapitulos();
            },
            async cargarCapitulos() {
                const { data } = await _supabase.from('capitulos').select('*').eq('obra_id', this.obraActiva.id).order('orden', { ascending: true });
                this.capitulos = data || [];
                if(this.capitulos.length > 0) this.cargarComentarios();
            },
            cambiarCapitulo(delta) {
                this.capituloActualIndex += delta;
                window.scrollTo(0, 0);
                this.cargarComentarios();
            },
            async cargarComentarios() {
                const capId = this.capitulos[this.capituloActualIndex]?.id;
                if(!capId) return;
                const { data } = await _supabase.from('comentarios').select('*').eq('capitulo_id', capId).order('fecha_comentario', { ascending: false });
                this.listaComentarios = data || [];
            },
            async postearComentario() {
                if (!this.user || !this.nuevoComentario) return;
                const { error } = await _supabase.from('comentarios').insert({
                    capitulo_id: this.capitulos[this.capituloActualIndex].id,
                    usuario_id: this.user.id,
                    mensaje: this.nuevoComentario
                });
                if(!error) { this.nuevoComentario = ''; this.cargarComentarios(); }
            },

            prepararCapitulo(obra) {
                this.obraParaCapitulo = obra;
                this.nuevoCap = { titulo: '', orden: 1, contenido: '', url: '' };
            },
            async subirCapitulo() {
                const { error } = await _supabase.from('capitulos').insert({
                    obra_id: this.obraParaCapitulo.id,
                    orden: this.nuevoCap.orden,
                    titulo_capitulo: this.nuevoCap.titulo,
                    contenido_texto: this.nuevoCap.contenido,
                    contenido_url: this.nuevoCap.url
                });
                if (error) alert(error.message);
                else {
                    alert("¬°Cap√≠tulo Publicado!");
                    this.nuevoCap = { titulo: '', orden: 1, contenido: '', url: '' };
                }
            },

            async registrarDonacion(monto) {
                if(!this.user) { this.view = 'auth'; return; }
                const { error } = await _supabase.from('donaciones').insert({
                    donante_id: this.user.id,
                    creador_id: this.obraActiva.autor_id,
                    monto: monto
                });
                if(!error) alert(`¬°Has donado $${monto} USD! El 95% llegar√° al autor.`);
            }
        }
    }).mount('#app')
</script>
</body>
</html>